<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poetry</title>
    <link rel="stylesheet" href="../bower_components/normalize-css/normalize.css"/>
    <link rel="stylesheet" href="../bower_components/unsemantic/assets/stylesheets/unsemantic-grid-responsive.css"/>

    <link rel="stylesheet" href="assets/style/poetry.css"/>
    <link rel="stylesheet" href="assets/style/fonts/fontastic/fontAwesome/styles.css"/>
</head>
<body>

    <div class="grid-container">
        <div class="grid-15">
            <h1><a href="/">Poetry</a></h1>
        </div>

        <div class="grid-45">
            <form action="search" method="get">

                <label for="search" class="search search-icon" data-icon="&#xe0d1;"></label>
                <input name="query" id="search" type="text" class="search"/>
                <label for="search" class="search clear-btn" data-icon="&#xe0c8;"></label>

                <div id="searchResult" class="grid-container"></div>
            </form>

        </div>

        <div class="grid-25">
            <a href="/new" style="margin-top: 32px; display: inline-block; ">Добавити</a>
        </div>

        <section class="grid-75 prefix-25">
            <pre>{{poem}}
                <a class="author" href="#"> {{author}} </a>
            </pre>
        </section>
    </div>

    <script>
        (function(){
            //Aliases
            var $ = Document.prototype.querySelector.bind(document),
                $$ = Document.prototype.querySelectorAll.bind(document);

            Element.prototype.on = Element.prototype.addEventListener;

            function higlightSearch(text, query){
                var regExp = new RegExp("(\n[^\n]*){0,5}" + query + "([^\n]*\n){0,5}", "i"),
                    exText = "\n" + text + "\n", // "\n" + text + "\n" - it is hak for simplifying regex. (It for select first and last strings.)
                    match = exText.match(regExp),
                    result;

                if (match){
                    result = match[0].replace(new RegExp("(" + query + ")", "ig"), "<span class='highlight'>$1</span>")
                } else {
                    result = text.match(/(\n?[^\n]*){0,8}/i)[0];
                }
                return result;
            }

            $("#search").on("keyup", function(e){
                if (!this.value) {
                    $("#searchResult").innerHTML = "";
                    return;
                }
                var XHR = new XMLHttpRequest(),
                    queryText = this.value;
                XHR.open('GET', '/search?' + "query=" + queryText);


                XHR.addEventListener("load", function(e){
                    var data = JSON.parse(XHR.responseText),
                        resultHtml = data.items.map(function(el, i) {
                            return "<div class='item'>" +
                                        "<span class='grid-25'>" + higlightSearch(el.author, queryText) + "</span>" +
                                        "<pre class='grid-75'>" + higlightSearch(el.poem, queryText) + "</pre>" +
                                    "</div>"
                        }).join(" ");

                    $("#searchResult").innerHTML = resultHtml;
                })

                XHR.send();
            });

            $(".search.clear-btn").on("click", function(){
                $("#search").value = ""
                $("#searchResult").innerHTML = "";
            }, false);
        })()

    </script>
</body>
</html>